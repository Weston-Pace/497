using Xfoil
using Printf
using DelimitedFiles
using Plots
 
"""
some important functions from the example include:
- Xfoil.set_coordinates(x,y) = Creates the airfoil from the data that is given
- Xfoil.pane() = Breaks up the airofil into panels
- Xfoil.solve_alpha(......) = Solves for the coefficients that we desire: such as lift, drag, moment
- adding _cs to the end of the functions lets the solve be over complex steps
- Xfoil.alpha_sweep(.....) = simplifies the process of collecting the coefficient data by going through the process automatically

Some pseudo code:
- solve for coefficients normally:

Get the airfoil dimensions into lists that are seperated by x and y coordinates, and then use Xfoil.set_coordinates to have the program create the airfoil.

Then use Xfoil.pane to panelize the airfoil

Then define the values of alpha, Reynold's number, and mach. Alpha should be a set of numbers with equals steps between them.

Then initialize the outputs. The outputs need to have the same length as the list of alpha values.

Then run the Xfoil.solve_alpha function to get the values, which are then printed

- solve for the derivatives of the coefficients with respect to alpha:

Get the airfoil dimensions into lists that are seperated by x and y coordinates, and then use Xfoil.set_coordinates to have the program create the airfoil.

Then use Xfoil.pane to panelize the airfoil

Then define the values of alpha, Reynold's number, and mach. Alpha should be a set of numbers with equals steps between them.

Choose a very small step in alpha that will be used to find the change in the coefficients

Then initialize the outputs. The outputs need to have the same length as the list of alpha values.

Solve for two sets of coefficients using Xfoil.solve_alpha; one will be at alpha, and the other will be at alpha + the small step.

Using the two different sets of data, find the change in the them by finding the difference, and then divide this by the small increment that was chosen.
This value will need to be put into radians by multiply by 180/pi.

Print the results

-Using the complex step method:

The steps are similar to the previous two examples, but the addition of _cs needs to be added to the end of the functions

*note: I need to ask Adam what the complex step method really does because I kind of have an idea about it, but It isn't a strong one

-Using alpha_sweep:

The process is very similar; however, the set_coordinate and pane function are not needed. Also, the outputs do not need to be initialized since it is 
automatically done through alpha_sweep.
"""
#Get the airfoil data
#Get delimited files
x = [1.00008381395326, 0.9901736426992191, 0.9802592975537332, 0.9703408558280057, 0.9604183923278614, 0.95049197943895,
 0.9405616872122786, 0.9306275834500856, 0.9206897337920666, 0.910748201801969, 0.9008030490545641, 0.8908543352230176, 
 0.8809021181666715, 0.8709464540192566, 0.8609873972775545, 0.8510250008905301, 0.841059316348957, 0.831090393775559, 
 0.8211182820156957, 0.8111430287286178, 0.8011646804793253, 0.7911832828310602, 0.7811988804384689, 0.7712115171414732, 
 0.761221236059894, 0.7512280796888696, 0.7412320899951208, 0.7312333085141147, 0.7212317764481875, 0.7112275347656878, 
 0.7012206243012109, 0.6912110858569994, 0.6811989603055932, 0.6711842886938172, 0.6611671123482082, 0.6511474729819874,
  0.6411254128036973, 0.631100974627634, 0.6210742019862185, 0.6110451392444641, 0.6010138317167155, 0.5909803257858509, 
  0.5809446690251617, 0.5709069103231449, 0.5608671000114707, 0.550825289996417, 0.5407815338940973, 0.5307358871698412, 
  0.5206884072821374, 0.5106391538315903, 0.5005881887154037, 0.490535576287965, 0.4804813835281781, 0.4704256802142796, 
  0.46036853910696907, 0.45031003614179826, 0.4402502506318978, 0.43018926548227104, 0.42012716741706774, 0.4100640472214609, 
  0.4, 0.38985403263666113, 0.3797064413445358, 0.3695574754527849, 0.359407396846057, 0.3492564808085287, 0.33910501694866874,
   0.32895331021736635, 0.3188016820345024, 0.30865047154203296, 0.29850003700536903, 0.2883507573894579, 0.278203034141777,
    0.2680572932217886, 0.25791398742576094, 0.24777359906788016, 0.2376366430941797, 0.22750367072623734, 0.21737527375863536,
     0.20725208967037959, 0.1971348077595447, 0.1870241765778173, 0.17692101303556967, 0.16682621368118486, 0.1567407688502377,
    0.14666578066224487, 0.13660248626660706, 0.12655228839210336, 0.11651679628750004, 0.1064978818284515, 0.09649775842374751,
    0.08651909540111286, 0.07656518991838708, 0.06664023688625961, 0.05674977642598308, 0.04690148889838964, 0.03710674378552701, 
    0.02738403389163398, 0.017768259834246843, 0.008346724923609982, 0.0, 0.0, 0.011653275076390019, 0.022231740165753158,
    0.03261596610836602, 0.04289325621447299, 0.05309851110161037, 0.06325022357401693, 0.0733597631137404,
    0.08343481008161292, 0.09348090459888714, 0.1035022415762525, 0.1135021181715485, 0.12348320371249995, 0.13344771160789665,
     0.14339751373339296, 0.15333421933775512, 0.16325923114976232, 0.17317378631881516, 0.1830789869644303, 0.1929758234221827,
    0.20286519224045532, 0.2127479103296204, 0.22262472624136465, 0.23249632927376268, 0.24236335690582028, 0.25222640093211984,
    0.2620860125742391, 0.2719427067782114, 0.28179696585822306, 0.29164924261054204, 0.30149996299463094, 0.31134952845796704,
        0.32119831796549764, 0.3310466897826337, 0.3408949830513313, 0.35074351919147123, 0.360592603153943, 0.3704425245472151,
        0.3802935586554642, 0.3901459673633389, 0.4, 0.40993595277853906, 0.41987283258293223, 0.42981073451772894, 
        0.4397497493681022, 0.44968996385820176, 0.459631460893031, 0.46957431978572034, 0.47951861647182187,
        0.48946442371203497, 0.4994118112845963, 0.5093608461684097, 0.5193115927178626, 0.5292641128301588, 
        0.5392184661059027, 0.5491747100035831, 0.5591328999885294, 0.569093089676855, 0.5790553309748382, 0.589019674214149, 
        0.5989861682832844, 0.6089548607555358, 0.6189257980137814, 0.628899025372366, 0.6388745871963027, 0.6488525270180127,
        0.6588328876517918, 0.6688157113061829, 0.6788010396944069, 0.6887889141430005, 0.698779375698789, 0.7087724652343121,
        0.7187682235518125, 0.7287666914858852, 0.7387679100048792, 0.7487719203111304, 0.758778763940106, 0.7687884828585269, 
        0.7788011195615312, 0.7888167171689399, 0.7988353195206748, 0.8088569712713823, 0.8188817179843042, 0.8289096062244409,
                 .8389406836510429, 0.8489749991094698, 0.8590126027224455, 0.8690535459807434, 0.8790978818333285, 0.8891456647769824, 
                 0.899196950945436, 0.909251798198031, 0.9193102662079334, 0.9293724165499145, 0.9394383127877213, 0.9495080205610499, 
                 0.9595816076721385, 0.9696591441719943, 0.9797407024462668, 0.9898263573007808, 0.99991618604674]
y = [0.001257209298899305, 0.003309898048352226, 0.005334693841454217, 0.007331934126406155, 0.009301940189837547,
 0.011245017081810103, 0.013161453537978566, 0.015051521898726819, 0.016915478025084592, 0.01875356121121715, 
 0.02056599409326469, 0.022352982554291998, 0.02411471562509137, 0.02585136538056378, 0.02756308683137976, 
 0.029250017810602838, 0.030912278854929674, 0.03254997308017815, 0.03416318605062232, 0.03575198564174316, 0.03731642189592898, 0.03885652687062042, 0.040372314478354494, 0.04186378031811538, 0.0433309014973496, 0.04477363644394951, 0.04619192470744532, 0.04758568674858274, 0.04895482371638569, 0.05029921721172596, 0.05161872903632783, 0.0529132009260386, 0.054182454267084096, 0.05542628979390528, 0.05664448726703514, 0.05783680512932386, 0.0590029801386478, 0.060142726975050756, 0.06125573782005056, 0.062341681905606475, 0.06340020502997562, 0.06443092903738248, 0.06543345125808817, 0.06640734390505867, 0.06735215342299807, 0.06826739978501738, 0.06915257573164872, 0.07000714594627375, 0.0708305461603045, 0.07162218218061725, 0.07238142883077964, 0.07310762879650386, 0.07380009136448461, 0.0744580910423014, 0.07508086604535291, 0.0756676166347949, 0.07621750328812417, 0.0767296446813216, 0.07720311545825975, 0.0776369437592945, 0.07803010847647902, 0.07837444533554998, 0.07866173109283747, 0.078890772962016, 0.07906031539430199, 0.0791690353176989, 0.07921553675541772, 0.07919834472192343, 0.07911589827488064, 0.07896654257631223, 0.07874851978523748, 0.07845995856516524, 0.07809886194076805, 0.07766309317573551, 0.07715035926397397, 0.07655819152319546, 0.07588392264550753, 0.07512465938265085, 0.07427724980810349, 0.07333824378148218, 0.07230384480910637, 0.07116985089871791, 0.06993158117146046, 0.06858378380548075, 0.06712051916270503, 0.0655350094040821, 0.06381944205219908, 0.0619647090058761, 0.059960053035713556, 0.05779257822825519, 0.055446554350033185, 0.05290239805015663, 0.05013512602016147, 0.04711190137867138, 0.043787924400199074, 0.04009905544697558, 0.035947291271922116, 0.031168214685038054, 0.025442001744770088, 0.01794416745015403, 0.0, 0.0, -0.01596916745015403, -0.021542001744770087, -0.02539321468503806, -0.02834729127192212, -0.030724055446975585, -0.032687924400199075, -0.03433690137867138, -0.035735126020161476, -0.03692739805015664, -0.03794655435003318, -0.038817578228255184, -0.039560053035713555, -0.040189709005876095, -0.04071944205219908, -0.041160009404082105, -0.04152051916270504, -0.041808783805480754, -0.042031581171460476, -0.04219485089871791, -0.04230384480910637, -0.04236324378148219, -0.04237724980810349, -0.04234965938265085, -0.042283922645507524, -0.04218319152319547, -0.04205035926397398, -0.04188809317573551, -0.04169886194076805, -0.04148495856516525, -0.041248519785237484, -0.040991542576312254, -0.040715898274880646, -0.04042334472192344, -0.04011553675541772, -0.039794035317698914, -0.03946031539430199, -0.039115772962016016, -0.03876173109283746, -0.03839944533554998, -0.038030108476479016, -0.037648054870405595, -0.037247559902704196, -0.03682964468132159, -0.03639528106590194, -0.03594539441257268, -0.03548086604535291, -0.03500253548674584, -0.03451120247559572, -0.03400762879650386, -0.03349253994189074, -0.0329666266250617, -0.03243054616030451, -0.03188492372405152, -0.031330353509426506, -0.030767399785017382, -0.030196597867442512, -0.029618455016169797, -0.029033451258088174, -0.0284420401484936, -0.02784464947442006, -0.02724168190560648, -0.02663351559782835, -0.026020504752828546, -0.025402980138647797, -0.024781249573768312, -0.02415559837814625, -0.023526289793905284, -0.022893565378195216, -0.022257645370483043, -0.021618729036327833, -0.020976994989503752, -0.020332601494163473, -0.019685686748582742, -0.019036369151889772, -0.018384747555060615, -0.017730901497349585, -0.017074891429226476, -0.016416758922798938, -0.015756526870620416, -0.01509419967370676, -0.014429763419520942, -0.013763186050622307, -0.013094417524622592, -0.012423389966040772, -0.011750017810602828, -0.01107419794249086, -0.010395809825008224, -0.009714715625091365, -0.009030760332069777, -0.008343771871042467, -0.007653561211217151, -0.006959922469529034, -0.006262633009837934, -0.005561453537978564, -0.004856128192921215, -0.004146384634281992, -0.0034319341264061522, -0.0027124716192319866, -0.001987675826130001, -0.001257209298899305]    

"""
Xfoil.set_coordinates(x,y)
Xfoil.pane()

#set values
alpha = -5:0.1:20

mach = 0.0
n_a = length(alpha)
#initialize values
re = 5e5
c_l = zeros(n_a)
c_d = zeros(n_a)
c_dp = zeros(n_a)
c_m = zeros(n_a)
converged = zeros(Bool, n_a)
for i = 1:n_a
    c_l[i], c_d[i], c_dp[i], c_m[i], converged[i] = Xfoil.solve_alpha(alpha[i], re; mach, iter = 500)
end

#display results

    
println("Angle\t\tCl\t\tCd\t\tCm\t\tConverged")
for i = 1:n_a
    @printf("%8f\t%8f\t%8f\t%8f\t%d\n",alpha[i],c_l[i],c_d[i],c_m[i],converged[i])
end
"""

#plot(alpha , c_l, xlabel = "Angle of Attack (degrees)" , ylabel = "Cl")
alpha = -5:0.1:20
re = 5e5
c_l, c_d, c_dp, c_m, converged = Xfoil.alpha_sweep(x, y, alpha, re, iter=100, zeroinit=false, printdata=true)

"""
derivative=[]
for i in 1:length(alpha)-1
    push!(derivative, (c_l[i+1]-c_l[i])/0.1)
end
append!(derivative , last(derivative))



function NACA(m,p,t)
    global y_u = []
    global x_u = []
    global y_l = []
    global x_l = []
    for i in 0:.01:1
        yt = 5*t*(0.2969*sqrt(i)-0.1260*i-0.3516*(i)^(2)+0.2843*(i)^(3)-0.1015*(i)^(4))
        if 0<=i<=p
            yc=(m/(p^2))*(2*p*i-i^2)
        else p<i<=1
            yc=(m/(1-p)^2)*((1-2*p)+2*p*i-i^2)
        end
        if 0<=i<=p
            derivative = (2*m/(p^2))*(p-i)
        else p<i<=1
            derivative = (2*m/(1-p)^2)*(p-i)
        end
        theta = atan(derivative)
        push!(x_u, i-yt*sin(theta))
        push!(y_u, yc+yt*cos(theta))
        push!(x_l, i+yt*sin(theta))
        push!(y_l, yc-yt*cos(theta))
    end
end


#derivative finder
Xfoil.set_coordinates(x,y)
Xfoil.pane()

#set values
alpha = -5:0.1:20

mach = 0.0
n_a = length(alpha)
#initialize values
re = 5e5
h = 1e-6

"""
# initialize outputs
n_a = length(alpha)
c_l_a = zeros(n_a)
c_d_a = zeros(n_a)
c_dp_a = zeros(n_a)
c_m_a = zeros(n_a)
converged = zeros(Bool, n_a)

for i = 1:n_a
    c_l1, c_d1, c_dp1, c_m1, converged[i] = Xfoil.solve_alpha(alpha[i], re; mach, iter=100)
    c_l2, c_d2, c_dp2, c_m2, converged[i] = Xfoil.solve_alpha(alpha[i]+h, re; mach, iter=100)
    c_l_a[i] = (c_l2 - c_l1)/h * 180/pi
    c_d_a[i] = (c_d2 - c_d1)/h * 180/pi
    c_m_a[i] = (c_m2 - c_m1)/h * 180/pi
end
        



